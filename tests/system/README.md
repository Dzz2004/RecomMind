# RAG系统性能测试

本目录包含RAG系统的性能测试脚本和测试用例。

## 文件说明

- `test_cases.jsonl`: 包含100个测试用例的JSONL文件，每行一个测试用例，格式为 `{"id": 1, "question": "问题内容"}`
- `performance_test.py`: 性能测试脚本，用于测试系统性能指标
- `performance_results.json`: 测试结果输出文件（运行测试后生成）

## 测试指标

性能测试脚本会测量以下指标：

1. **检索阶段耗时**：从开始检索到检索完成的时间（包括生成检索建议、向量检索、相关性判断等）
2. **首字生成时间（TTFT）**：从开始生成到第一个token出现的时间
3. **推理生成时间**：从第一个token到生成完成的时间
4. **总耗时**：整个查询处理的总时间

## 使用方法

### 基本使用

```bash
cd /home/ubuntu/qj_temp/workflow_wxk/test/system
python3 performance_test.py
```

### 自定义参数

```bash
python3 performance_test.py \
    --test-cases test_cases.jsonl \
    --output performance_results.json \
    --limit 10 \
    --llm-path "../models--Qwen--Qwen3-8B/snapshots/9c925d64d72725edaf899c6cb9c377fd0709d9c5" \
    --embedding-model-path "/home/ubuntu/.cache/huggingface/hub/models--BAAI--bge-m3/snapshots/5617a9f61b028005a4858fdac845db406aefb181/" \
    --db-path "./vector_db" \
    --similarity-threshold 0.0 \
    --use-quantization True
```

### 参数说明

- `--test-cases`: 测试用例文件路径（默认：`test_cases.jsonl`）
- `--output`: 测试结果输出文件路径（默认：`performance_results.json`）
- `--limit`: 限制测试用例数量，用于快速测试（默认：None，测试所有用例）
- `--llm-path`: LLM模型路径
- `--embedding-model-path`: 嵌入模型路径
- `--db-path`: 向量数据库路径
- `--similarity-threshold`: 相似度阈值（默认：0.0）
- `--use-quantization`: 是否使用4位量化（默认：True）

### 快速测试（只测试前10个用例）

```bash
python3 performance_test.py --limit 10
```

## 输出结果

测试完成后会生成 `performance_results.json` 文件，包含：

1. **测试时间戳**
2. **每个测试用例的详细指标**：
   - 测试ID和问题
   - 检索耗时
   - 首字生成时间
   - 推理生成时间
   - 总耗时
   - 检索到的chunk数量
   - 响应长度
   - 是否成功
   - 错误信息（如果有）

3. **测试摘要**：
   - 总测试数、成功数、失败数
   - 各项指标的平均值、中位数、最小值、最大值

## 示例输出

测试脚本会在控制台输出每个测试用例的进度和最终摘要：

```
================================================================================
测试 1: linux内存管理是什么
================================================================================
...
✅ 测试 1 完成
   检索耗时: 2.345秒
   首字生成时间: 0.123秒
   推理生成时间: 5.678秒
   总耗时: 8.146秒
   检索到 5 个chunk
   响应长度: 1234 字符

================================================================================
测试摘要
================================================================================
总测试数: 100
成功: 98
失败: 2

检索阶段耗时:
  平均: 2.345秒
  中位数: 2.123秒
  最小: 1.234秒
  最大: 5.678秒

首字生成时间 (TTFT):
  平均: 0.123秒
  中位数: 0.115秒
  最小: 0.089秒
  最大: 0.234秒

推理生成时间:
  平均: 5.678秒
  中位数: 5.234秒
  最小: 3.456秒
  最大: 12.345秒

总耗时:
  平均: 8.146秒
  中位数: 7.890秒
  最小: 5.123秒
  最大: 18.234秒
================================================================================
```

## 注意事项

1. 确保已正确配置模型路径和向量数据库路径
2. 首次运行可能需要较长时间加载模型
3. 建议先用 `--limit` 参数进行小规模测试
4. 测试过程中会清空对话历史，每个测试用例都是独立的
5. 如果遇到错误，检查模型路径、依赖包和向量数据库是否正确配置

## 故障排除

### 模型加载失败
- 检查模型路径是否正确
- 确保有足够的内存/显存
- 检查CUDA环境（如果使用GPU）

### 向量数据库错误
- 确保 `db_path` 目录存在且有写权限
- 检查ChromaDB版本兼容性

### 测试用例加载失败
- 检查 `test_cases.jsonl` 文件格式是否正确
- 确保文件编码为 UTF-8

