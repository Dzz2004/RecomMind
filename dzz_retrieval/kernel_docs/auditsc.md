# auditsc.c

> 自动生成时间: 2025-10-25 11:53:09
> 
> 生成工具: 通义千问 API (qwen3-max)
> 
> 原始文件: `auditsc.c`

---

# auditsc.c 技术文档

## 1. 文件概述

`auditsc.c` 是 Linux 内核审计子系统的核心组件之一，专门负责**系统调用级别的审计功能**。该文件实现了系统调用进入和退出时的审计数据收集、过滤规则匹配、辅助数据管理以及与 LSM（Linux Security Module）安全模块的集成。它为内核审计框架提供了系统调用上下文的完整记录能力，支持对文件操作、网络配置、进程执行等关键系统行为进行细粒度监控和日志记录。

## 2. 核心功能

### 主要数据结构

- **`audit_aux_data`**: 审计辅助数据的通用基类，用于链式存储额外的审计信息
- **`audit_aux_data_pids`**: 存储目标进程相关信息（PID、UID、会话ID、安全上下文等），最多支持16个目标进程
- **`audit_aux_data_bprm_fcaps`**: 记录可执行文件能力（capabilities）变更信息，包括文件能力、旧进程能力和新进程能力
- **`audit_tree_refs`**: 用于管理文件系统审计树（audit tree）引用的链表结构，每个节点包含31个`audit_chunk`指针
- **`audit_nfcfgop_tab`**: 网络过滤配置操作的枚举到字符串映射表，支持 iptables 和 nftables 操作审计

### 关键函数

- **`audit_match_perm()`**: 根据系统调用类型和访问模式（读/写/属性/执行）匹配审计权限过滤规则
- **`audit_match_filetype()`**: 匹配审计上下文中文件的类型（如普通文件、目录、设备文件等）
- **`audit_set_auditable()`**: 将审计上下文标记为可审计状态，设置优先级和记录状态
- **`put_tree_ref()` / `grow_tree_refs()` / `unroll_tree_refs()`**: 管理审计树引用的动态分配和释放

### 全局变量

- **`audit_n_rules`**: 当前系统中审计规则的总数
- **`audit_signals`**: 控制是否收集信号发送相关的审计数据

## 3. 关键实现

### 系统调用分类与权限匹配

`audit_match_perm()` 函数实现了复杂的系统调用分类逻辑：
- **原生系统调用**（`AUDITSC_NATIVE`）：通过预定义的系统调用类（`AUDIT_CLASS_WRITE`、`AUDIT_CLASS_READ` 等）进行匹配
- **兼容模式系统调用**（`AUDITSC_COMPAT`）：针对32位兼容层的特殊处理
- **特殊系统调用处理**：
  - `open`/`openat`：直接从参数中提取访问模式
  - `openat2`：从 `struct open_how` 的 flags 字段解析访问模式
  - `socketcall`：特殊处理 `SYS_BIND` 操作
  - `execve`：匹配执行权限

### 审计树引用管理

采用**固定大小数组链表**的设计模式管理 `audit_chunk` 引用：
- 每个 `audit_tree_refs` 节点包含31个指针槽位
- 初始状态为 `(NULL, NULL, 0)`，首次分配后变为 `(p, p, 31)`
- 通过 `tree_count` 跟踪当前节点的可用槽位数
- 不支持收缩，仅在上下文释放时统一清理

### 辅助数据扩展机制

通过**继承式链表设计**支持多种辅助数据类型：
- 所有辅助数据结构都以 `audit_aux_data` 作为第一个成员
- 通过 `type` 字段区分不同类型的数据
- 支持动态添加新的辅助数据类型而无需修改核心逻辑

### 网络配置审计支持

内置对现代网络过滤框架的完整支持：
- **iptables**（`xt_*` 操作）
- **nftables**（`nft_*` 操作，包括表、链、规则、集合、对象、流表等）
- 提供操作码到可读字符串的映射，便于用户空间解析

## 4. 依赖关系

### 内核头文件依赖

- **审计核心**：`<linux/audit.h>`、`"audit.h"`
- **系统调用**：`<asm/syscall.h>`、`<linux/syscalls.h>`
- **安全模块**：`<linux/security.h>`、`<linux/capability.h>`
- **文件系统**：`<linux/fs.h>`、`<linux/namei.h>`、`<linux/mount.h>`
- **网络**：`<linux/socket.h>`、`<uapi/linux/netfilter/nf_tables.h>`
- **进程管理**：`<linux/binfmts.h>`、`<linux/personality.h>`

### 功能依赖

- **审计框架**：依赖 `audit.c` 提供的核心审计功能
- **LSM 框架**：与 SELinux、Smack 等安全模块集成，支持安全上下文审计
- **系统调用拦截**：依赖架构特定的系统调用入口/出口钩子（如 `entry.S`）
- **文件系统通知**：与 `fsnotify` 子系统协作实现文件访问审计

## 5. 使用场景

### 系统调用审计

- **文件操作监控**：记录所有文件创建、删除、重命名、权限修改等操作
- **进程执行跟踪**：审计 `execve` 系统调用，记录命令行参数和环境变量
- **网络配置变更**：监控 iptables/nftables 规则的添加、删除、修改
- **能力变更审计**：跟踪进程能力的获取、丢弃和继承过程

### 安全合规

- **LSPP 认证**：支持主体/客体安全上下文标签审计，满足高安全等级要求
- **访问控制审计**：记录所有违反 MAC（强制访问控制）策略的访问尝试
- **特权操作监控**：审计所有涉及 root 权限或特殊能力的系统调用

### 故障诊断与取证

- **系统行为分析**：通过审计日志重建系统调用序列，分析异常行为
- **安全事件响应**：在安全事件发生后，通过审计记录追踪攻击路径
- **合规性报告**：生成满足法规要求的系统活动审计报告