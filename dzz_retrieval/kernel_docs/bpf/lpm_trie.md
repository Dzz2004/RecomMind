# bpf\lpm_trie.c

> 自动生成时间: 2025-10-25 12:16:29
> 
> 生成工具: 通义千问 API (qwen3-max)
> 
> 原始文件: `bpf\lpm_trie.c`

---

# bpf/lpm_trie.c 技术文档

## 1. 文件概述

`bpf/lpm_trie.c` 实现了基于最长前缀匹配（Longest Prefix Match, LPM）算法的 BPF 映射（map）类型，主要用于高效匹配 IP 地址前缀。该数据结构特别适用于网络路由、访问控制列表（ACL）等需要根据 IP 地址前缀进行快速查找的场景。该实现支持 IPv4 和 IPv6 地址，并通过前缀树（Trie）结构实现高效的插入、查找和删除操作。

## 2. 核心功能

### 主要数据结构

- **`struct lpm_trie_node`**  
  表示前缀树中的一个节点，包含：
  - `rcu`：用于 RCU（Read-Copy-Update）内存回收机制
  - `child[2]`：指向左右子节点的指针（0 和 1 分支）
  - `prefixlen`：该节点表示的前缀长度（位数）
  - `flags`：节点标志，`LPM_TREE_NODE_FLAG_IM` 表示中间节点（无用户数据）
  - `data[]`：变长数组，存储前缀数据（大端序）

- **`struct lpm_trie`**  
  表示整个 LPM Trie 映射，包含：
  - `map`：嵌入的 `bpf_map` 基类
  - `root`：指向根节点的 RCU 指针
  - `n_entries`：当前条目数量
  - `max_prefixlen`：最大前缀长度（如 32 表示 IPv4，128 表示 IPv6）
  - `data_size`：前缀数据字节数（如 4 字节对应 IPv4）
  - `lock`：自旋锁，用于同步更新操作

### 主要函数

- **`extract_bit()`**  
  从字节数组中提取指定索引位置的比特位（大端序）。

- **`longest_prefix_match()`**  
  计算给定节点与查询键之间的最长匹配前缀长度，利用字对齐和字长优化（32/64 位）加速比较。

- **`trie_lookup_elem()`**  
  实现 BPF map 的查找接口，从根节点开始遍历 Trie，返回匹配路径中最深的非中间节点（即具有用户数据的节点）。

## 3. 关键实现

### 前缀树结构设计

- 所有前缀数据以**大端序**存储，`data[0]` 为最高有效字节。
- 节点分为两类：
  - **真实节点**：包含用户通过 `bpf_map_update_elem()` 设置的值。
  - **中间节点（Intermediate Node）**：仅用于路径分叉，无用户数据，由 `LPM_TREE_NODE_FLAG_IM` 标识。
- 插入新前缀时，若路径上已有更短前缀，则沿比特路径向下查找；若需分叉但子节点已存在，则插入新的中间节点以扩展路径。

### 高效前缀匹配算法

- `longest_prefix_match()` 函数通过逐字（word-wise）比较加速前缀匹配：
  - 在支持高效非对齐访问的 64 位平台上，优先使用 64 位比较。
  - 否则依次尝试 32 位、16 位和 8 位比较。
  - 利用 `fls()`/`fls64()`（Find Last Set）快速定位第一个不同比特位。

### 并发与内存管理

- **读操作（lookup）**：使用 RCU 机制，无需加锁，支持高并发。
- **写操作（update/delete）**：通过自旋锁 `trie->lock` 保证原子性。
- 节点内存通过 `kmalloc`/`vmalloc` 分配，并通过 RCU 回收。

### 查找逻辑

- 从根节点开始，逐层向下遍历。
- 每次根据当前节点前缀长度之后的下一位比特值（0 或 1）选择子节点。
- 记录遍历路径中最后一个**非中间节点**作为候选结果。
- 当无法继续向下匹配时，返回该候选节点的值。

## 4. 依赖关系

- **内核头文件依赖**：
  - `<linux/bpf.h>`：BPF 核心框架
  - `<linux/rcupdate.h>`（通过 `<linux/bpf.h>` 间接包含）：RCU 机制
  - `<linux/slab.h>` / `<linux/vmalloc.h>`：内存分配
  - `<net/ipv6.h>`：IPv6 相关辅助函数（如 `ipv6_addr_prefix()`）
  - `<linux/btf.h>`：BPF 类型格式（BTF）支持
- **BPF 子系统**：作为 `BPF_MAP_TYPE_LPM_TRIE` 类型的后端实现，与 BPF verifier、map 操作接口紧密集成。
- **网络子系统**：主要用于 IP 路由和策略匹配，但本身不直接依赖网络协议栈。

## 5. 使用场景

- **eBPF 程序中的 IP 路由查找**：例如在 XDP 或 TC 程序中根据目标 IP 查找下一跳或策略。
- **访问控制**：匹配 IP 前缀以决定是否允许流量（如防火墙规则）。
- **负载均衡**：根据客户端 IP 前缀进行会话保持或区域路由。
- **网络监控**：按 IP 段聚合流量统计。
- **用户空间工具**：通过 `bpf()` 系统调用管理 LPM Trie 映射，实现动态策略更新。