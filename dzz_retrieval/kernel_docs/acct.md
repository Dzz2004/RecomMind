# acct.c

> 自动生成时间: 2025-10-25 11:48:07
> 
> 生成工具: 通义千问 API (qwen3-max)
> 
> 原始文件: `acct.c`

---

# Linux 内核进程记账模块（acct.c）技术文档

## 1. 文件概述

`acct.c` 实现了 BSD 风格的 Linux 进程记账（Process Accounting）功能。当任意进程退出时，内核会向通过 `acct()` 系统调用指定的文件中写入一条类型为 `struct acct` 的记账记录。该模块仅负责生成原始记账数据，具体的数据分析和处理由用户空间程序完成。此功能可用于系统资源使用审计、用户行为追踪和性能分析等场景。

## 2. 核心功能

### 主要数据结构

- **`struct bsd_acct_struct`**：进程记账核心控制结构
  - `pin`：文件系统 pin 机制，防止记账文件被意外卸载
  - `count`：引用计数，用于安全释放资源
  - `active`：记账功能是否处于激活状态
  - `check_space`：是否启用磁盘空间检查
  - `needcheck`：下次磁盘空间检查的时间点
  - `file`：记账文件的 file 结构指针
  - `ns`：关联的 PID 命名空间
  - `work`：用于异步关闭记账文件的工作队列
  - `ac`：实际的记账数据结构（`acct_t` 类型）

### 主要函数

- **`acct_on()`**：启用进程记账功能，打开指定文件并初始化记账结构
- **`check_free_space()`**：检查磁盘剩余空间，根据阈值暂停或恢复记账
- **`acct_pin_kill()`**：安全关闭记账功能，处理资源清理
- **`close_work()`**：工作队列回调函数，异步执行记账文件关闭操作
- **`acct_get()`**：获取当前命名空间的记账结构，带引用计数管理
- **`acct_put()`**：减少记账结构引用计数，必要时释放内存
- **`fill_ac()`** 和 **`acct_write_process()`**：填充和写入进程记账记录（声明但未在提供的代码片段中实现）

### 系统参数

- **`acct_parm[3]`**：记账系统控制参数数组
  - `acct_parm[0]`（RESUME）：磁盘剩余空间百分比阈值，超过此值恢复记账
  - `acct_parm[1]`（SUSPEND）：磁盘剩余空间百分比阈值，低于此值暂停记账  
  - `acct_parm[2]`（ACCT_TIMEOUT）：磁盘空间检查间隔时间（秒）

## 3. 关键实现

### 磁盘空间监控机制

记账系统实现了智能的磁盘空间管理：
- 当可用磁盘空间低于 `SUSPEND` 百分比时，自动暂停记账以避免填满磁盘
- 当可用磁盘空间恢复到 `RESUME` 百分比以上时，自动恢复记账
- 通过 `needcheck` 字段控制检查频率，避免频繁的磁盘 I/O 操作

### 资源安全管理和并发控制

- **引用计数机制**：使用 `atomic_long_t count` 确保记账结构在多线程环境下的安全访问和释放
- **RCU 读取优化**：通过 RCU 机制实现高效的记账结构读取，减少锁竞争
- **互斥锁保护**：`mutex lock` 保护关键操作，防止竞态条件
- **文件系统 pin 机制**：防止记账文件所在的文件系统被意外卸载

### 异步关闭机制

- 使用工作队列（`work_struct`）异步处理记账文件关闭操作
- 通过 `completion` 机制确保关闭操作完成后再释放资源
- 在关闭前调用文件操作的 `flush` 方法确保数据写入磁盘

### 安全性和验证

- 验证目标文件必须是普通文件（`S_ISREG`）
- 排除内核内部文件系统（`SB_NOUSER | SB_KERNMOUNT`）
- 排除特殊文件系统如 procfs 和 sysfs（`SB_I_USERNS_VISIBLE`）
- 验证文件必须具有写权限（`FMODE_CAN_WRITE`）

## 4. 依赖关系

### 内核头文件依赖

- **内存管理**：`<linux/mm.h>`, `<linux/slab.h>`
- **文件系统**：`<linux/vfs.h>`, `<linux/file.h>`, `<linux/mount.h>`, `<linux/fs_pin.h>`
- **进程管理**：`<linux/sched/cputime.h>`, `<linux/pid_namespace.h>`
- **系统调用**：`<linux/syscalls.h>`, `<linux/uaccess.h>`
- **安全机制**：`<linux/capability.h>`, `<linux/security.h>`
- **设备支持**：`<linux/tty.h>`
- **时间管理**：`<linux/jiffies.h>`, `<linux/times.h>`

### 内核子系统交互

- **VFS 层**：通过标准 VFS 接口进行文件操作和文件系统状态查询
- **内存管理子系统**：使用 slab 分配器分配记账结构内存
- **工作队列子系统**：利用内核工作队列处理异步关闭操作
- **RCU 机制**：使用 RCU 进行无锁读取操作
- **sysctl 接口**：提供运行时可调参数（当 `CONFIG_SYSCTL` 启用时）

## 5. 使用场景

### 系统管理员监控

- 通过 `acct()` 系统调用启用进程记账，收集系统中所有进程的执行信息
- 分析用户资源使用情况，识别异常进程行为
- 监控系统负载和进程执行模式

### 安全审计

- 记录所有进程的执行历史，包括命令名、执行时间、资源消耗等
- 用于事后安全事件分析和取证
- 检测未授权的程序执行

### 性能分析

- 收集进程 CPU 时间、内存使用、I/O 操作等性能指标
- 分析系统资源瓶颈和优化机会
- 监控长时间运行的进程资源消耗趋势

### 容器环境支持

- 通过 PID 命名空间隔离，支持容器级别的进程记账
- 每个命名空间可以独立配置记账文件和参数
- 为容器监控和计费提供基础数据支持