# ksm.c

> 自动生成时间: 2025-12-07 16:34:25
> 
> 生成工具: 通义千问 API (qwen3-max)
> 
> 原始文件: `ksm.c`

---

# ksm.c 技术文档

## 1. 文件概述

`ksm.c` 实现了内核同页合并（Kernel Samepage Merging, KSM）功能，该机制能够动态识别并合并内容完全相同的物理内存页，即使这些页属于不同的进程地址空间且未通过 `fork()` 共享。KSM 通过后台扫描线程周期性地遍历注册的内存区域，利用红黑树（rbtree）结构高效地比对页面内容，将重复页替换为只读的共享页，从而显著减少物理内存占用。此功能特别适用于虚拟化环境中多个相似虚拟机共存的场景。

## 2. 核心功能

### 主要数据结构

- **`struct ksm_mm_slot`**  
  表示一个被 KSM 扫描的内存描述符（`mm_struct`）的元数据，包含哈希槽位和反向映射项链表头。

- **`struct ksm_scan`**  
  全局扫描游标，记录当前扫描进度（包括当前 `mm_slot`、虚拟地址、反向映射项指针及完整扫描轮次计数）。

- **`struct ksm_stable_node`**  
  稳定红黑树中的节点，代表一个已合并的 KSM 页面。包含：
  - 红黑树节点或迁移链表指针（联合体复用）
  - 指向使用该 KSM 页的所有 `rmap_item` 的哈希链表头
  - 物理页帧号（`kpfn`）或链修剪时间戳
  - 反向映射项数量（支持链式扩展）
  - NUMA 节点 ID（若启用 NUMA）

- **`struct ksm_rmap_item`**  
  反向映射项，跟踪一个虚拟地址到其物理页的映射关系。包含：
  - 所属 `mm_struct` 和虚拟地址（低比特位用于标志）
  - 匿名 VMA 指针（稳定状态）或 NUMA 节点 ID（不稳定状态）
  - 校验和（不稳定状态）
  - 红黑树节点（不稳定树）或指向 `stable_node` 的指针及哈希链表节点（稳定状态）

### 关键宏定义

- **`STABLE_NODE_CHAIN`**  
  标识稳定节点为“链”类型（值为 -1024），用于高效管理大量相同内容的 KSM 页副本。
  
- **标志位**  
  - `UNSTABLE_FLAG` (0x100)：标识 `rmap_item` 属于不稳定树
  - `STABLE_FLAG` (0x200)：标识 `rmap_item` 已链接到稳定树
  - `SEQNR_MASK` (0x0ff)：用于存储不稳定树序列号的低 8 位

## 3. 关键实现

### 双树架构设计
KSM 采用**稳定树（stable tree）**与**不稳定树（unstable tree）**协同工作的机制：
- **稳定树**：存储已确认可合并的只读 KSM 页，因写保护而内容恒定，支持高效精确匹配。
- **不稳定树**：临时缓存近期未修改的普通页，因内容可能变化而需周期性重建。

### 扫描与合并流程
1. **增量扫描**：全局游标 `ksm_scan` 遍历所有注册的 `mm_slot` 及其内存区域。
2. **校验和预筛**：计算页面内容的 `xxhash` 校验和，仅当与上次扫描一致时才尝试插入不稳定树。
3. **双阶段匹配**：
   - 优先在**稳定树**中查找完全匹配的 KSM 页
   - 若未命中，则在**不稳定树**中查找潜在重复页
4. **树维护策略**：
   - 不稳定树在每轮全量扫描结束后**完全清空重建**
   - 稳定树**持久保留**，通过反向映射（rmap）和链式节点优化大规模合并场景
5. **NUMA 感知**：若 `merge_across_nodes=0`，则为每个 NUMA 节点维护独立的稳定/不稳定树，避免跨节点内存访问开销。

### 内存安全机制
- **写保护**：合并后的 KSM 页设为只读，任何写操作触发 COW（写时复制）并解除合并。
- **RMAP 集成**：通过 `anon_vma` 和反向映射链表，在页解绑时高效更新所有相关虚拟地址。
- **OOM 防护**：在内存压力下可释放 KSM 页以缓解系统压力。

## 4. 依赖关系

- **内存管理子系统**：深度依赖 `mm.h`、`rmap.h`、`pagemap.h` 实现页表操作、反向映射和页生命周期管理。
- **调度与进程管理**：通过 `sched/mm.h` 获取进程内存上下文，利用 `kthread.h` 创建后台扫描线程。
- **NUMA 支持**：条件编译依赖 `CONFIG_NUMA`，使用 `numa.h` 实现节点亲和性。
- **调试与追踪**：集成 `trace/events/ksm.h` 提供运行时事件追踪能力。
- **哈希算法**：使用 `xxhash.h` 提供高效的内容指纹计算。
- **内部辅助模块**：依赖 `mm_slot.h` 管理内存描述符槽位，`internal.h` 提供内核 MM 内部接口。

## 5. 使用场景

- **虚拟化环境**：在 KVM/Xen 等 Hypervisor 中合并多个相似虚拟机的内存页（如相同操作系统镜像）。
- **内存密集型应用**：合并大型应用（如数据库、Web 服务器）中重复的静态数据或零页。
- **容器化平台**：在 Docker/LXC 等容器运行时中减少同镜像容器的内存占用。
- **内存超分场景**：在物理内存有限但允许超额分配的系统中提升内存利用率。
- **开发调试**：通过 `/sys/kernel/mm/ksm/` 接口动态控制扫描速率、合并阈值等参数。